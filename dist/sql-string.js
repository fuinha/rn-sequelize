'use strict';

const dataTypes = require('./data-types');

const {
  logger
} = require('./utils/logger');

function arrayToList(array, timeZone, dialect, format) {
  return array.reduce((sql, val, i) => {
    if (i !== 0) {
      sql += ', ';
    }

    if (Array.isArray(val)) {
      sql += `(${arrayToList(val, timeZone, dialect, format)})`;
    } else {
      sql += escape(val, timeZone, dialect, format);
    }

    return sql;
  }, '');
}

exports.arrayToList = arrayToList;

function escape(val, timeZone, dialect, format) {
  let prependN = false;

  if (val === undefined || val === null) {
    return 'NULL';
  }

  switch (typeof val) {
    case 'boolean':
      // SQLite doesn't have true/false support. MySQL aliases true/false to 1/0
      // for us. Postgres actually has a boolean type with true/false literals,
      // but sequelize doesn't use it yet.
      if (dialect === 'sqlite' || dialect === 'mssql') {
        return +!!val;
      }

      return (!!val).toString();

    case 'number':
      return val.toString();

    case 'string':
      // In mssql, prepend N to all quoted vals which are originally a string (for
      // unicode compatibility)
      prependN = dialect === 'mssql';
      break;
  }

  if (val instanceof Date) {
    val = dataTypes[dialect].DATE.prototype.stringify(val, {
      timezone: timeZone
    });
  }

  if (Buffer.isBuffer(val)) {
    if (dataTypes[dialect].BLOB) {
      return dataTypes[dialect].BLOB.prototype.stringify(val);
    }

    return dataTypes.BLOB.prototype.stringify(val);
  }

  if (Array.isArray(val)) {
    const partialEscape = escVal => escape(escVal, timeZone, dialect, format);

    if (dialect === 'postgres' && !format) {
      return dataTypes.ARRAY.prototype.stringify(val, {
        escape: partialEscape
      });
    }

    return arrayToList(val, timeZone, dialect, format);
  }

  if (!val.replace) {
    throw new Error(`Invalid value ${logger.inspect(val)}`);
  }

  if (dialect === 'postgres' || dialect === 'sqlite' || dialect === 'mssql') {
    // http://www.postgresql.org/docs/8.2/static/sql-syntax-lexical.html#SQL-SYNTAX-STRINGS
    // http://stackoverflow.com/q/603572/130598
    val = val.replace(/'/g, "''");

    if (dialect === 'postgres') {
      // null character is not allowed in Postgres
      val = val.replace(/\0/g, '\\0');
    }
  } else {
    // eslint-disable-next-line no-control-regex
    val = val.replace(/[\0\n\r\b\t\\'"\x1a]/g, s => {
      switch (s) {
        case '\0':
          return '\\0';

        case '\n':
          return '\\n';

        case '\r':
          return '\\r';

        case '\b':
          return '\\b';

        case '\t':
          return '\\t';

        case '\x1a':
          return '\\Z';

        default:
          return `\\${s}`;
      }
    });
  }

  return `${(prependN ? "N'" : "'") + val}'`;
}

exports.escape = escape;

function format(sql, values, timeZone, dialect) {
  values = [].concat(values);

  if (typeof sql !== 'string') {
    throw new Error(`Invalid SQL string provided: ${sql}`);
  }

  return sql.replace(/\?/g, match => {
    if (!values.length) {
      return match;
    }

    return escape(values.shift(), timeZone, dialect, true);
  });
}

exports.format = format;

function formatNamedParameters(sql, values, timeZone, dialect) {
  return sql.replace(/:+(?!\d)(\w+)/g, (value, key) => {
    if ('postgres' === dialect && '::' === value.slice(0, 2)) {
      return value;
    }

    if (values[key] !== undefined) {
      return escape(values[key], timeZone, dialect, true);
    }

    throw new Error(`Named parameter "${value}" has no value in the given object.`);
  });
}

exports.formatNamedParameters = formatNamedParameters;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9zcWwtc3RyaW5nLmpzIl0sIm5hbWVzIjpbImRhdGFUeXBlcyIsInJlcXVpcmUiLCJsb2dnZXIiLCJhcnJheVRvTGlzdCIsImFycmF5IiwidGltZVpvbmUiLCJkaWFsZWN0IiwiZm9ybWF0IiwicmVkdWNlIiwic3FsIiwidmFsIiwiaSIsIkFycmF5IiwiaXNBcnJheSIsImVzY2FwZSIsImV4cG9ydHMiLCJwcmVwZW5kTiIsInVuZGVmaW5lZCIsInRvU3RyaW5nIiwiRGF0ZSIsIkRBVEUiLCJwcm90b3R5cGUiLCJzdHJpbmdpZnkiLCJ0aW1lem9uZSIsIkJ1ZmZlciIsImlzQnVmZmVyIiwiQkxPQiIsInBhcnRpYWxFc2NhcGUiLCJlc2NWYWwiLCJBUlJBWSIsInJlcGxhY2UiLCJFcnJvciIsImluc3BlY3QiLCJzIiwidmFsdWVzIiwiY29uY2F0IiwibWF0Y2giLCJsZW5ndGgiLCJzaGlmdCIsImZvcm1hdE5hbWVkUGFyYW1ldGVycyIsInZhbHVlIiwia2V5Iiwic2xpY2UiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE1BQU1BLFNBQVMsR0FBR0MsT0FBTyxDQUFDLGNBQUQsQ0FBekI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQWFELE9BQU8sQ0FBQyxnQkFBRCxDQUExQjs7QUFFQSxTQUFTRSxXQUFULENBQXFCQyxLQUFyQixFQUE0QkMsUUFBNUIsRUFBc0NDLE9BQXRDLEVBQStDQyxNQUEvQyxFQUF1RDtBQUNyRCxTQUFPSCxLQUFLLENBQUNJLE1BQU4sQ0FBYSxDQUFDQyxHQUFELEVBQU1DLEdBQU4sRUFBV0MsQ0FBWCxLQUFpQjtBQUNuQyxRQUFJQSxDQUFDLEtBQUssQ0FBVixFQUFhO0FBQ1hGLE1BQUFBLEdBQUcsSUFBSSxJQUFQO0FBQ0Q7O0FBQ0QsUUFBSUcsS0FBSyxDQUFDQyxPQUFOLENBQWNILEdBQWQsQ0FBSixFQUF3QjtBQUN0QkQsTUFBQUEsR0FBRyxJQUFLLElBQUdOLFdBQVcsQ0FBQ08sR0FBRCxFQUFNTCxRQUFO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bUJNLEtBQUssSUFBSTtBQUNqQyxRQUFJLENBQUNGLE1BQU0sQ0FBQ0csTUFBWixFQUFvQjtBQUNsQixhQUFPRCxLQUFQO0FBQ0Q7O0FBRUQsV0FBT3RCLE1BQU0sQ0FBQ29CLE1BQU0sQ0FBQ0ksS0FBUCxFQUFELEVBQWlCakMsUUFBakIsRUFBMkJDLE9BQTNCLEVBQW9DLElBQXBDLENBQWI7QUFDRCxHQU5NLENBQVA7QUFPRDs7QUFDRFMsT0FBTyxDQUFDUixNQUFSLEdBQWlCQSxNQUFqQjs7QUFFQSxTQUFTZ0MscUJBQVQsQ0FBK0I5QixHQUEvQixFQUFvQ3lCLE1BQXBDLEVBQTRDN0IsUUFBNUMsRUFBc0RDLE9BQXRELEVBQStEO0FBQzdELFNBQU9HLEdBQUcsQ0FBQ3FCLE9BQUosQ0FBWSxnQkFBWixFQUE4QixDQUFDVSxLQUFELEVBQVFDLEdBQVIsS0FBZ0I7QUFDbkQsUUFBSSxlQUFlbkMsT0FBZixJQUEwQixTQUFTa0MsS0FBSyxDQUFDRSxLQUFOLENBQVksQ0FBWixFQUFlLENBQWYsQ0FBdkMsRUFBMEQ7QUFDeEQsYUFBT0YsS0FBUDtBQUNEOztBQUVELFFBQUlOLE1BQU0sQ0FBQ08sR0FBRCxDQUFOLEtBQWdCeEIsU0FBcEIsRUFBK0I7QUFDN0IsYUFBT0gsTUFBTSxDQUFDb0IsTUFBTSxDQUFDTyxHQUFELENBQVAsRUFBY3BDLFFBQWQsRUFBd0JDLE9BQXhCLEVBQWlDLElBQWpDLENBQWI7QUFDRDs7QUFDRCxVQUFNLElBQUl5QixLQUFKLENBQVcsb0JBQW1CUyxLQUFNLHFDQUFwQyxDQUFOO0FBQ0QsR0FUTSxDQUFQO0FBVUQ7O0FBQ0R6QixPQUFPLENBQUN3QixxQkFBUixHQUFnQ0EscUJBQWhDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG5cclxuY29uc3QgZGF0YVR5cGVzID0gcmVxdWlyZSgnLi9kYXRhLXR5cGVzJyk7XHJcbmNvbnN0IHsgbG9nZ2VyIH0gPSByZXF1aXJlKCcuL3V0aWxzL2xvZ2dlcicpO1xyXG5cclxuZnVuY3Rpb24gYXJyYXlUb0xpc3QoYXJyYXksIHRpbWVab25lLCBkaWFsZWN0LCBmb3JtYXQpIHtcclxuICByZXR1cm4gYXJyYXkucmVkdWNlKChzcWwsIHZhbCwgaSkgPT4ge1xyXG4gICAgaWYgKGkgIT09IDApIHtcclxuICAgICAgc3FsICs9ICcsICc7XHJcbiAgICB9XHJcbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7XHJcbiAgICAgIHNxbCArPSBgKCR7YXJyYXlUb0xpc3QodmFsLCB0aW1lWm9uZSwgZGlhbGVjdCwgZm9ybWF0KX0pYDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHNxbCArPSBlc2NhcGUodmFsLCB0aW1lWm9uZSwgZGlhbGVjdCwgZm9ybWF0KTtcclxuICAgIH1cclxuICAgIHJldHVybiBzcWw7XHJcbiAgfSwgJycpO1xyXG59XHJcbmV4cG9ydHMuYXJyYXlUb0xpc3QgPSBhcnJheVRvTGlzdDtcclxuXHJcbmZ1bmN0aW9uIGVzY2FwZSh2YWwsIHRpbWVab25lLCBkaWFsZWN0LCBmb3JtYXQpIHtcclxuICBsZXQgcHJlcGVuZE4gPSBmYWxzZTtcclxuICBpZiAodmFsID09PSB1bmRlZmluZWQgfHwgdmFsID09PSBudWxsKSB7XHJcbiAgICByZXR1cm4gJ05VTEwnO1xyXG4gIH1cclxuICBzd2l0Y2ggKHR5cGVvZiB2YWwpIHtcclxuICAgIGNhc2UgJ2Jvb2xlYW4nOlxyXG4gICAgLy8gU1FMaXRlIGRvZXNuJ3QgaGF2ZSB0cnVlL2ZhbHNlIHN1cHBvcnQuIE15U1FMIGFsaWFzZXMgdHJ1ZS9mYWxzZSB0byAxLzBcclxuICAgIC8vIGZvciB1cy4gUG9zdGdyZXMgYWN0dWFsbHkgaGFzIGEgYm9vbGVhbiB0eXBlIHdpdGggdHJ1ZS9mYWxzZSBsaXRlcmFscyxcclxuICAgIC8vIGJ1dCBzZXF1ZWxpemUgZG9lc24ndCB1c2UgaXQgeWV0LlxyXG4gICAgICBpZiAoZGlhbGVjdCA9PT0gJ3NxbGl0ZScgfHwgZGlhbGVjdCA9PT0gJ21zc3FsJykge1xyXG4gICAgICAgIHJldHVybiArISF2YWw7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuICghIXZhbCkudG9TdHJpbmcoKTtcclxuICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgIHJldHVybiB2YWwudG9TdHJpbmcoKTtcclxuICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAvLyBJbiBtc3NxbCwgcHJlcGVuZCBOIHRvIGFsbCBxdW90ZWQgdmFscyB3aGljaCBhcmUgb3JpZ2luYWxseSBhIHN0cmluZyAoZm9yXHJcbiAgICAvLyB1bmljb2RlIGNvbXBhdGliaWxpdHkpXHJcbiAgICAgIHByZXBlbmROID0gZGlhbGVjdCA9PT0gJ21zc3FsJztcclxuICAgICAgYnJlYWs7XHJcbiAgfVxyXG5cclxuICBpZiAodmFsIGluc3RhbmNlb2YgRGF0ZSkge1xyXG4gICAgdmFsID0gZGF0YVR5cGVzW2RpYWxlY3RdLkRBVEUucHJvdG90eXBlLnN0cmluZ2lmeSh2YWwsIHsgdGltZXpvbmU6IHRpbWVab25lIH0pO1xyXG4gIH1cclxuXHJcbiAgaWYgKEJ1ZmZlci5pc0J1ZmZlcih2YWwpKSB7XHJcbiAgICBpZiAoZGF0YVR5cGVzW2RpYWxlY3RdLkJMT0IpIHtcclxuICAgICAgcmV0dXJuIGRhdGFUeXBlc1tkaWFsZWN0XS5CTE9CLnByb3RvdHlwZS5zdHJpbmdpZnkodmFsKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZGF0YVR5cGVzLkJMT0IucHJvdG90eXBlLnN0cmluZ2lmeSh2YWwpO1xyXG4gIH1cclxuXHJcbiAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkge1xyXG4gICAgY29uc3QgcGFydGlhbEVzY2FwZSA9IGVzY1ZhbCA9PiBlc2NhcGUoZXNjVmFsLCB0aW1lWm9uZSwgZGlhbGVjdCwgZm9ybWF0KTtcclxuICAgIGlmIChkaWFsZWN0ID09PSAncG9zdGdyZXMnICYmICFmb3JtYXQpIHtcclxuICAgICAgcmV0dXJuIGRhdGFUeXBlcy5BUlJBWS5wcm90b3R5cGUuc3RyaW5naWZ5KHZhbCwgeyBlc2NhcGU6IHBhcnRpYWxFc2NhcGUgfSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYXJyYXlUb0xpc3QodmFsLCB0aW1lWm9uZSwgZGlhbGVjdCwgZm9ybWF0KTtcclxuICB9XHJcblxyXG4gIGlmICghdmFsLnJlcGxhY2UpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCB2YWx1ZSAke2xvZ2dlci5pbnNwZWN0KHZhbCl9YCk7XHJcbiAgfVxyXG5cclxuICBpZiAoZGlhbGVjdCA9PT0gJ3Bvc3RncmVzJyB8fCBkaWFsZWN0ID09PSAnc3FsaXRlJyB8fCBkaWFsZWN0ID09PSAnbXNzcWwnKSB7XHJcbiAgICAvLyBodHRwOi8vd3d3LnBvc3RncmVzcWwub3JnL2RvY3MvOC4yL3N0YXRpYy9zcWwtc3ludGF4LWxleGljYWwuaHRtbCNTUUwtU1lOVEFYLVNUUklOR1NcclxuICAgIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xLzYwMzU3Mi8xMzA1OThcclxuICAgIHZhbCA9IHZhbC5yZXBsYWNlKC8nL2csIFwiJydcIik7XHJcblxyXG4gICAgaWYgKGRpYWxlY3QgPT09ICdwb3N0Z3JlcycpIHtcclxuICAgICAgLy8gbnVsbCBjaGFyYWN0ZXIgaXMgbm90IGFsbG93ZWQgaW4gUG9zdGdyZXNcclxuICAgICAgdmFsID0gdmFsLnJlcGxhY2UoL1xcMC9nLCAnXFxcXDAnKTtcclxuICAgIH1cclxuICB9IGVsc2Uge1xyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnRyb2wtcmVnZXhcclxuICAgIHZhbCA9IHZhbC5yZXBsYWNlKC9bXFwwXFxuXFxyXFxiXFx0XFxcXCdcIlxceDFhXS9nLCBzID0+IHtcclxuICAgICAgc3dpdGNoIChzKSB7XHJcbiAgICAgICAgY2FzZSAnXFwwJzogcmV0dXJuICdcXFxcMCc7XHJcbiAgICAgICAgY2FzZSAnXFxuJzogcmV0dXJuICdcXFxcbic7XHJcbiAgICAgICAgY2FzZSAnXFxyJzogcmV0dXJuICdcXFxccic7XHJcbiAgICAgICAgY2FzZSAnXFxiJzogcmV0dXJuICdcXFxcYic7XHJcbiAgICAgICAgY2FzZSAnXFx0JzogcmV0dXJuICdcXFxcdCc7XHJcbiAgICAgICAgY2FzZSAnXFx4MWEnOiByZXR1cm4gJ1xcXFxaJztcclxuICAgICAgICBkZWZhdWx0OiByZXR1cm4gYFxcXFwke3N9YDtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHJldHVybiBgJHsocHJlcGVuZE4gPyBcIk4nXCIgOiBcIidcIikgKyB2YWx9J2A7XHJcbn1cclxuZXhwb3J0cy5lc2NhcGUgPSBlc2NhcGU7XHJcblxyXG5mdW5jdGlvbiBmb3JtYXQoc3FsLCB2YWx1ZXMsIHRpbWVab25lLCBkaWFsZWN0KSB7XHJcbiAgdmFsdWVzID0gW10uY29uY2F0KHZhbHVlcyk7XHJcblxyXG4gIGlmICh0eXBlb2Ygc3FsICE9PSAnc3RyaW5nJykge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIFNRTCBzdHJpbmcgcHJvdmlkZWQ6ICR7c3FsfWApO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHNxbC5yZXBsYWNlKC9cXD8vZywgbWF0Y2ggPT4ge1xyXG4gICAgaWYgKCF2YWx1ZXMubGVuZ3RoKSB7XHJcbiAgICAgIHJldHVybiBtYXRjaDtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZXNjYXBlKHZhbHVlcy5zaGlmdCgpLCB0aW1lWm9uZSwgZGlhbGVjdCwgdHJ1ZSk7XHJcbiAgfSk7XHJcbn1cclxuZXhwb3J0cy5mb3JtYXQgPSBmb3JtYXQ7XHJcblxyXG5mdW5jdGlvbiBmb3JtYXROYW1lZFBhcmFtZXRlcnMoc3FsLCB2YWx1ZXMsIHRpbWVab25lLCBkaWFsZWN0KSB7XHJcbiAgcmV0dXJuIHNxbC5yZXBsYWNlKC86Kyg/IVxcZCkoXFx3KykvZywgKHZhbHVlLCBrZXkpID0+IHtcclxuICAgIGlmICgncG9zdGdyZXMnID09PSBkaWFsZWN0ICYmICc6OicgPT09IHZhbHVlLnNsaWNlKDAsIDIpKSB7XHJcbiAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodmFsdWVzW2tleV0gIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICByZXR1cm4gZXNjYXBlKHZhbHVlc1trZXldLCB0aW1lWm9uZSwgZGlhbGVjdCwgdHJ1ZSk7XHJcbiAgICB9XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoYE5hbWVkIHBhcmFtZXRlciBcIiR7dmFsdWV9XCIgaGFzIG5vIHZhbHVlIGluIHRoZSBnaXZlbiBvYmplY3QuYCk7XHJcbiAgfSk7XHJcbn1cclxuZXhwb3J0cy5mb3JtYXROYW1lZFBhcmFtZXRlcnMgPSBmb3JtYXROYW1lZFBhcmFtZXRlcnM7XHJcbiJdfQ==