'use strict';

const _ = require('lodash');

const HasOne = require('./has-one');

const HasMany = require('./has-many');

const BelongsToMany = require('./belongs-to-many');

const BelongsTo = require('./belongs-to');

function isModel(model, sequelize) {
  return model && model.prototype && model.prototype instanceof sequelize.Sequelize.Model;
}

const Mixin = {
  hasMany(target, options = {}) {
    if (!isModel(target, this.sequelize)) {
      throw new Error(`${this.name}.hasMany called with something that's not a subclass of Sequelize.Model`);
    }

    const source = this; // Since this is a mixin, we'll need a unique letiable name for hooks (since Model will override our hooks option)

    options.hooks = options.hooks === undefined ? false : Boolean(options.hooks);
    options.useHooks = options.hooks;
    options = Object.assign(options, _.omit(source.options, ['hooks']));

    if (options.useHooks) {
      this.runHooks('beforeAssociate', {
        source,
        target,
        type: HasMany
      }, options);
    } // the id is in the foreign table or in a connecting table


    const association = new HasMany(source, target, options);
    source.associations[association.associationAccessor] = association;

    association._injectAttributes();

    association.mixin(source.prototype);

    if (options.useHooks) {
      this.runHooks('afterAssociate', {
        source,
        target,
        type: HasMany,
        association
      }, options);
    }

    return association;
  },

  belongsToMany(target, options = {}) {
    if (!isModel(target, this.sequelize)) {
      throw new Error(`${this.name}.belongsToMany called with something that's not a subclass of Sequelize.Model`);
    }

    const source = this; // Since this is a mixin, we'll need a unique letiable name for hooks (since Model will override our hooks option)

    options.hooks = options.hooks === undefined ? false : Boolean(options.hooks);
    options.useHooks = options.hooks;
    options.timestamps = options.timestamps === undefined ? this.sequelize.options.timestamps : options.timestamps;
    options = Object.assign(options, _.omit(source.options, ['hooks', 'timestamps', 'scopes', 'defaultScope']));

    if (options.useHooks) {
      this.runHooks('beforeAssociate', {
        source,
        target,
        type: BelongsToMany
      }, options);
    } // the id is in the foreign table or in a connecting table


    const association = new BelongsToMany(source, target, options);
    source.associations[association.associationAccessor] = association;

    association._injectAttributes();

    association.mixin(source.prototype);

    if (options.useHooks) {
      this.runHooks('afterAssociate', {
        source,
        target,
        type: BelongsToMany,
        association
      }, options);
    }

    return association;
  },

  getAssociations(target) {
    return _.values(this.associations).filter(association => association.target.name === target.name);
  },

  getAssociationForAlias(target, alias) {
    // Two associations cannot have the same alias, so we can use find instead of filter
    return this.getAssociations(target).find(association => association.verifyAssociationAlias(alias)) || null;
  }

}; // The logic for hasOne and belongsTo is exactly the same

function singleLinked(Type) {
  return function (target, options = {}) {
    // eslint-disable-next-line no-invalid-this
    const source = this;

    if (!isModel(target, source.sequelize)) {
      throw new Error(`${source.name}.${_.lowerFirst(Type.name)} called with something that's not a subclass of Sequelize.Model`);
    } // Since this is a mixin, we'll need a unique letiable name for hooks (since Model will override our hooks option)


    options.hooks = options.hooks === undefined ? false : Boolean(options.hooks);
    options.useHooks = options.hooks;

    if (options.useHooks) {
      source.runHooks('beforeAssociate', {
        source,
        target,
        type: Type
      }, options);
    } // the id is in the foreign table


    const association = new Type(source, target, Object.assign(options, source.options));
    source.associations[association.associationAccessor] = association;

    association._injectAttributes();

    association.mixin(source.prototype);

    if (options.useHooks) {
      source.runHooks('afterAssociate', {
        source,
        target,
        type: Type,
        association
      }, options);
    }

    return association;
  };
}

Mixin.hasOne = singleLinked(HasOne);
Mixin.belongsTo = singleLinked(BelongsTo);
module.exports = Mixin;
module.exports.Mixin = Mixin;
module.exports.default = Mixin;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9hc3NvY2lhdGlvbnMvbWl4aW4uanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJIYXNPbmUiLCJIYXNNYW55IiwiQmVsb25nc1RvTWFueSIsIkJlbG9uZ3NUbyIsImlzTW9kZWwiLCJtb2RlbCIsInNlcXVlbGl6ZSIsInByb3RvdHlwZSIsIlNlcXVlbGl6ZSIsIk1vZGVsIiwiTWl4aW4iLCJoYXNNYW55IiwidGFyZ2V0Iiwib3B0aW9ucyIsIkVycm9yIiwibmFtZSIsInNvdXJjZSIsImhvb2tzIiwidW5kZWZpbmVkIiwiQm9vbGVhbiIsInVzZUhvb2tzIiwiT2JqZWN0IiwiYXNzaWduIiwib21pdCIsInJ1bkhvb2tzIiwidHlwZSIsImFzc29jaWF0aW9uIiwiYXNzb2NpYXRpb25zIiwiYXNzb2NpYXRpb25BY2Nlc3NvciIsIl9pbmplY3RBdHRyaWJ1dGVzIiwibWl4aW4iLCJiZWxvbmdzVG9NYW55IiwidGltZXN0YW1wcyIsImdldEFzc29jaWF0aW9ucyIsInZhbHVlcyIsImZpbHRlciIsImdldEFzc29jaWF0aW9uRm9yQWxpYXMiLCJhbGlhcyIsImZpbmQiLCJ2ZXJpZnlBc3NvY2lhdGlvbkFsaWFzIiwic2luZ2xlTGlua2VkIiwiVHlwZSIsImxvd2VyRmlyc3QiLCJoYXNPbmUiLCJiZWxvbmdzVG8iLCJtb2R1bGUiLCJleHBvcnRzIiwiZGVmYXVsdCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsTUFBTUEsQ0FBQyxHQUFHQyxPQUFPLENBQUMsUUFBRCxDQUFqQjs7QUFDQSxNQUFNQyxNQUFNLEdBQUdELE9BQU8sQ0FBQyxXQUFELENBQXRCOztBQUNBLE1BQU1FLE9BQU8sR0FBR0YsT0FBTyxDQUFDLFlBQUQsQ0FBdkI7O0FBQ0EsTUFBTUcsYUFBYSxHQUFHSCxPQUFPLENBQUMsbUJBQUQsQ0FBN0I7O0FBQ0EsTUFBTUksU0FBUyxHQUFHSixPQUFPLENBQUMsY0FBRCxDQUF6Qjs7QUFFQSxTQUFTSyxPQUFULENBQWlCQyxLQUFqQixF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O0FBQ0EsVUFBTWEsV0FBVyxHQUFHLElBQUllLElBQUosQ0FBU3pCLE1BQVQsRUFBaUJKLE1BQWpCLEVBQXlCUyxNQUFNLENBQUNDLE1BQVAsQ0FBY1QsT0FBZCxFQUF1QkcsTUFBTSxDQUFDSCxPQUE5QixDQUF6QixDQUFwQjtBQUNBRyxJQUFBQSxNQUFNLENBQUNXLFlBQVAsQ0FBb0JELFdBQVcsQ0FBQ0UsbUJBQWhDLElBQXVERixXQUF2RDs7QUFFQUEsSUFBQUEsV0FBVyxDQUFDRyxpQkFBWjs7QUFDQUgsSUFBQUEsV0FBVyxDQUFDSSxLQUFaLENBQWtCZCxNQUFNLENBQUNULFNBQXpCOztBQUVBLFFBQUlNLE9BQU8sQ0FBQ08sUUFBWixFQUFzQjtBQUNwQkosTUFBQUEsTUFBTSxDQUFDUSxRQUFQLENBQWdCLGdCQUFoQixFQUFrQztBQUFFUixRQUFBQSxNQUFGO0FBQVVKLFFBQUFBLE1BQVY7QUFBa0JhLFFBQUFBLElBQUksRUFBRWdCLElBQXhCO0FBQThCZixRQUFBQTtBQUE5QixPQUFsQyxFQUErRWIsT0FBL0U7QUFDRDs7QUFFRCxXQUFPYSxXQUFQO0FBQ0QsR0EzQkQ7QUE0QkQ7O0FBRURoQixLQUFLLENBQUNpQyxNQUFOLEdBQWVILFlBQVksQ0FBQ3hDLE1BQUQsQ0FBM0I7QUFDQVUsS0FBSyxDQUFDa0MsU0FBTixHQUFrQkosWUFBWSxDQUFDckMsU0FBRCxDQUE5QjtBQUVBMEMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCcEMsS0FBakI7QUFDQW1DLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlcEMsS0FBZixHQUF1QkEsS0FBdkI7QUFDQW1DLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlQyxPQUFmLEdBQXlCckMsS0FBekIiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XHJcbmNvbnN0IEhhc09uZSA9IHJlcXVpcmUoJy4vaGFzLW9uZScpO1xyXG5jb25zdCBIYXNNYW55ID0gcmVxdWlyZSgnLi9oYXMtbWFueScpO1xyXG5jb25zdCBCZWxvbmdzVG9NYW55ID0gcmVxdWlyZSgnLi9iZWxvbmdzLXRvLW1hbnknKTtcclxuY29uc3QgQmVsb25nc1RvID0gcmVxdWlyZSgnLi9iZWxvbmdzLXRvJyk7XHJcblxyXG5mdW5jdGlvbiBpc01vZGVsKG1vZGVsLCBzZXF1ZWxpemUpIHtcclxuICByZXR1cm4gbW9kZWxcclxuICAgICYmIG1vZGVsLnByb3RvdHlwZVxyXG4gICAgJiYgbW9kZWwucHJvdG90eXBlIGluc3RhbmNlb2Ygc2VxdWVsaXplLlNlcXVlbGl6ZS5Nb2RlbDtcclxufVxyXG5cclxuY29uc3QgTWl4aW4gPSB7XHJcbiAgaGFzTWFueSh0YXJnZXQsIG9wdGlvbnMgPSB7fSkge1xyXG4gICAgaWYgKCFpc01vZGVsKHRhcmdldCwgdGhpcy5zZXF1ZWxpemUpKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgJHt0aGlzLm5hbWV9Lmhhc01hbnkgY2FsbGVkIHdpdGggc29tZXRoaW5nIHRoYXQncyBub3QgYSBzdWJjbGFzcyBvZiBTZXF1ZWxpemUuTW9kZWxgKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzb3VyY2UgPSB0aGlzO1xyXG5cclxuICAgIC8vIFNpbmNlIHRoaXMgaXMgYSBtaXhpbiwgd2UnbGwgbmVlZCBhIHVuaXF1ZSBsZXRpYWJsZSBuYW1lIGZvciBob29rcyAoc2luY2UgTW9kZWwgd2lsbCBvdmVycmlkZSBvdXIgaG9va3Mgb3B0aW9uKVxyXG4gICAgb3B0aW9ucy5ob29rcyA9IG9wdGlvbnMuaG9va3MgPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogQm9vbGVhbihvcHRpb25zLmhvb2tzKTtcclxuICAgIG9wdGlvbnMudXNlSG9va3MgPSBvcHRpb25zLmhvb2tzO1xyXG5cclxuICAgIG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKG9wdGlvbnMsIF8ub21pdChzb3VyY2Uub3B0aW9ucywgWydob29rcyddKSk7XHJcblxyXG4gICAgaWYgKG9wdGlvbnMudXNlSG9va3MpIHtcclxuICAgICAgdGhpcy5ydW5Ib29rcygnYmVmb3JlQXNzb2NpYXRlJywgeyBzb3VyY2UsIHRhcmdldCwgdHlwZTogSGFzTWFueSB9LCBvcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyB0aGUgaWQgaXMgaW4gdGhlIGZvcmVpZ24gdGFibGUgb3IgaW4gYSBjb25uZWN0aW5nIHRhYmxlXHJcbiAgICBjb25zdCBhc3NvY2lhdGlvbiA9IG5ldyBIYXNNYW55KHNvdXJjZSwgdGFyZ2V0LCBvcHRpb25zKTtcclxuICAgIHNvdXJjZS5hc3NvY2lhdGlvbnNbYXNzb2NpYXRpb24uYXNzb2NpYXRpb25BY2Nlc3Nvcl0gPSBhc3NvY2lhdGlvbjtcclxuXHJcbiAgICBhc3NvY2lhdGlvbi5faW5qZWN0QXR0cmlidXRlcygpO1xyXG4gICAgYXNzb2NpYXRpb24ubWl4aW4oc291cmNlLnByb3RvdHlwZSk7XHJcblxyXG4gICAgaWYgKG9wdGlvbnMudXNlSG9va3MpIHtcclxuICAgICAgdGhpcy5ydW5Ib29rcygnYWZ0ZXJBc3NvY2lhdGUnLCB7IHNvdXJjZSwgdGFyZ2V0LCB0eXBlOiBIYXNNYW55LCBhc3NvY2lhdGlvbiB9LCBvcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gYXNzb2NpYXRpb247XHJcbiAgfSxcclxuXHJcbiAgYmVsb25nc1RvTWFueSh0YXJnZXQsIG9wdGlvbnMgPSB7fSkge1xyXG4gICAgaWYgKCFpc01vZGVsKHRhcmdldCwgdGhpcy5zZXF1ZWxpemUpKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgJHt0aGlzLm5hbWV9LmJlbG9uZ3NUb01hbnkgY2FsbGVkIHdpdGggc29tZXRoaW5nIHRoYXQncyBub3QgYSBzdWJjbGFzcyBvZiBTZXF1ZWxpemUuTW9kZWxgKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzb3VyY2UgPSB0aGlzO1xyXG5cclxuICAgIC8vIFNpbmNlIHRoaXMgaXMgYSBtaXhpbiwgd2UnbGwgbmVlZCBhIHVuaXF1ZSBsZXRpYWJsZSBuYW1lIGZvciBob29rcyAoc2luY2UgTW9kZWwgd2lsbCBvdmVycmlkZSBvdXIgaG9va3Mgb3B0aW9uKVxyXG4gICAgb3B0aW9ucy5ob29rcyA9IG9wdGlvbnMuaG9va3MgPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogQm9vbGVhbihvcHRpb25zLmhvb2tzKTtcclxuICAgIG9wdGlvbnMudXNlSG9va3MgPSBvcHRpb25zLmhvb2tzO1xyXG4gICAgb3B0aW9ucy50aW1lc3RhbXBzID0gb3B0aW9ucy50aW1lc3RhbXBzID09PSB1bmRlZmluZWQgPyB0aGlzLnNlcXVlbGl6ZS5vcHRpb25zLnRpbWVzdGFtcHMgOiBvcHRpb25zLnRpbWVzdGFtcHM7XHJcbiAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbihvcHRpb25zLCBfLm9taXQoc291cmNlLm9wdGlvbnMsIFsnaG9va3MnLCAndGltZXN0YW1wcycsICdzY29wZXMnLCAnZGVmYXVsdFNjb3BlJ10pKTtcclxuXHJcbiAgICBpZiAob3B0aW9ucy51c2VIb29rcykge1xyXG4gICAgICB0aGlzLnJ1bkhvb2tzKCdiZWZvcmVBc3NvY2lhdGUnLCB7IHNvdXJjZSwgdGFyZ2V0LCB0eXBlOiBCZWxvbmdzVG9NYW55IH0sIG9wdGlvbnMpO1xyXG4gICAgfVxyXG4gICAgLy8gdGhlIGlkIGlzIGluIHRoZSBmb3JlaWduIHRhYmxlIG9yIGluIGEgY29ubmVjdGluZyB0YWJsZVxyXG4gICAgY29uc3QgYXNzb2NpYXRpb24gPSBuZXcgQmVsb25nc1RvTWFueShzb3VyY2UsIHRhcmdldCwgb3B0aW9ucyk7XHJcbiAgICBzb3VyY2UuYXNzb2NpYXRpb25zW2Fzc29jaWF0aW9uLmFzc29jaWF0aW9uQWNjZXNzb3JdID0gYXNzb2NpYXRpb247XHJcblxyXG4gICAgYXNzb2NpYXRpb24uX2luamVjdEF0dHJpYnV0ZXMoKTtcclxuICAgIGFzc29jaWF0aW9uLm1peGluKHNvdXJjZS5wcm90b3R5cGUpO1xyXG5cclxuICAgIGlmIChvcHRpb25zLnVzZUhvb2tzKSB7XHJcbiAgICAgIHRoaXMucnVuSG9va3MoJ2FmdGVyQXNzb2NpYXRlJywgeyBzb3VyY2UsIHRhcmdldCwgdHlwZTogQmVsb25nc1RvTWFueSwgYXNzb2NpYXRpb24gfSwgb3B0aW9ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGFzc29jaWF0aW9uO1xyXG4gIH0sXHJcblxyXG4gIGdldEFzc29jaWF0aW9ucyh0YXJnZXQpIHtcclxuICAgIHJldHVybiBfLnZhbHVlcyh0aGlzLmFzc29jaWF0aW9ucykuZmlsdGVyKGFzc29jaWF0aW9uID0+IGFzc29jaWF0aW9uLnRhcmdldC5uYW1lID09PSB0YXJnZXQubmFtZSk7XHJcbiAgfSxcclxuXHJcbiAgZ2V0QXNzb2NpYXRpb25Gb3JBbGlhcyh0YXJnZXQsIGFsaWFzKSB7XHJcbiAgICAvLyBUd28gYXNzb2NpYXRpb25zIGNhbm5vdCBoYXZlIHRoZSBzYW1lIGFsaWFzLCBzbyB3ZSBjYW4gdXNlIGZpbmQgaW5zdGVhZCBvZiBmaWx0ZXJcclxuICAgIHJldHVybiB0aGlzLmdldEFzc29jaWF0aW9ucyh0YXJnZXQpLmZpbmQoYXNzb2NpYXRpb24gPT4gYXNzb2NpYXRpb24udmVyaWZ5QXNzb2NpYXRpb25BbGlhcyhhbGlhcykpIHx8IG51bGw7XHJcbiAgfVxyXG59O1xyXG5cclxuLy8gVGhlIGxvZ2ljIGZvciBoYXNPbmUgYW5kIGJlbG9uZ3NUbyBpcyBleGFjdGx5IHRoZSBzYW1lXHJcbmZ1bmN0aW9uIHNpbmdsZUxpbmtlZChUeXBlKSB7XHJcbiAgcmV0dXJuIGZ1bmN0aW9uKHRhcmdldCwgb3B0aW9ucyA9IHt9KSB7XHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8taW52YWxpZC10aGlzXHJcbiAgICBjb25zdCBzb3VyY2UgPSB0aGlzO1xyXG4gICAgaWYgKCFpc01vZGVsKHRhcmdldCwgc291cmNlLnNlcXVlbGl6ZSkpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3NvdXJjZS5uYW1lfS4ke18ubG93ZXJGaXJzdChUeXBlLm5hbWUpfSBjYWxsZWQgd2l0aCBzb21ldGhpbmcgdGhhdCdzIG5vdCBhIHN1YmNsYXNzIG9mIFNlcXVlbGl6ZS5Nb2RlbGApO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICAvLyBTaW5jZSB0aGlzIGlzIGEgbWl4aW4sIHdlJ2xsIG5lZWQgYSB1bmlxdWUgbGV0aWFibGUgbmFtZSBmb3IgaG9va3MgKHNpbmNlIE1vZGVsIHdpbGwgb3ZlcnJpZGUgb3VyIGhvb2tzIG9wdGlvbilcclxuICAgIG9wdGlvbnMuaG9va3MgPSBvcHRpb25zLmhvb2tzID09PSB1bmRlZmluZWQgPyBmYWxzZSA6IEJvb2xlYW4ob3B0aW9ucy5ob29rcyk7XHJcbiAgICBvcHRpb25zLnVzZUhvb2tzID0gb3B0aW9ucy5ob29rcztcclxuXHJcbiAgICBpZiAob3B0aW9ucy51c2VIb29rcykge1xyXG4gICAgICBzb3VyY2UucnVuSG9va3MoJ2JlZm9yZUFzc29jaWF0ZScsIHsgc291cmNlLCB0YXJnZXQsIHR5cGU6IFR5cGUgfSwgb3B0aW9ucyk7XHJcbiAgICB9XHJcbiAgICAvLyB0aGUgaWQgaXMgaW4gdGhlIGZvcmVpZ24gdGFibGVcclxuICAgIGNvbnN0IGFzc29jaWF0aW9uID0gbmV3IFR5cGUoc291cmNlLCB0YXJnZXQsIE9iamVjdC5hc3NpZ24ob3B0aW9ucywgc291cmNlLm9wdGlvbnMpKTtcclxuICAgIHNvdXJjZS5hc3NvY2lhdGlvbnNbYXNzb2NpYXRpb24uYXNzb2NpYXRpb25BY2Nlc3Nvcl0gPSBhc3NvY2lhdGlvbjtcclxuXHJcbiAgICBhc3NvY2lhdGlvbi5faW5qZWN0QXR0cmlidXRlcygpO1xyXG4gICAgYXNzb2NpYXRpb24ubWl4aW4oc291cmNlLnByb3RvdHlwZSk7XHJcblxyXG4gICAgaWYgKG9wdGlvbnMudXNlSG9va3MpIHtcclxuICAgICAgc291cmNlLnJ1bkhvb2tzKCdhZnRlckFzc29jaWF0ZScsIHsgc291cmNlLCB0YXJnZXQsIHR5cGU6IFR5cGUsIGFzc29jaWF0aW9uIH0sIG9wdGlvbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBhc3NvY2lhdGlvbjtcclxuICB9O1xyXG59XHJcblxyXG5NaXhpbi5oYXNPbmUgPSBzaW5nbGVMaW5rZWQoSGFzT25lKTtcclxuTWl4aW4uYmVsb25nc1RvID0gc2luZ2xlTGlua2VkKEJlbG9uZ3NUbyk7XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IE1peGluO1xyXG5tb2R1bGUuZXhwb3J0cy5NaXhpbiA9IE1peGluO1xyXG5tb2R1bGUuZXhwb3J0cy5kZWZhdWx0ID0gTWl4aW47XHJcbiJdfQ==