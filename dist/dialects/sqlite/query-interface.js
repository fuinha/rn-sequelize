'use strict';

const _ = require('lodash');

const Promise = require('../../promise');

const sequelizeErrors = require('../../errors');

const QueryTypes = require('../../query-types');
/**
 Returns an object that treats SQLite's inabilities to do certain queries.

 @class QueryInterface
 @static
 @private
 */

/**
  A wrapper that fixes SQLite's inability to remove columns from existing tables.
  It will create a backup of the table, drop the table afterwards and create a
  new table with the same name but without the obsolete column.

  @param  {QueryInterface} qi
  @param  {string} tableName     The name of the table.
  @param  {string} attributeName The name of the attribute that we want to remove.
  @param  {Object} options
  @param  {boolean|Function} [options.logging] A function that logs the sql queries, or false for explicitly not logging these queries

  @since 1.6.0
  @private
 */


function removeColumn(qi, tableName, attributeName, options) {
  options = options || {};
  return qi.describeTable(tableName, options).then(fields => {
    delete fields[attributeName];
    const sql = qi.QueryGenerator.removeColumnQuery(tableName, fields);
    const subQueries = sql.split(';').filter(q => q !== '');
    return Promise.each(subQueries, subQuery => qi.sequelize.query(`${subQuery};`, Object.assign({
      raw: true
    }, options)));
  });
}

exports.removeColumn = removeColumn;
/**
  A wrapper that fixes SQLite's inability to change columns from existing tables.
  It will create a backup of the table, drop the table afterwards and create a
  new table with the same name but with a modified version of the respective column.

  @param  {QueryInterface} qi
  @param  {string} tableName The name of the table.
  @param  {Object} attributes An object with the attribute's name as key and its options as value object.
  @param  {Object} options
  @param  {boolean|Function} [options.logging] A function that logs the sql queries, or false for explicitly not logging these queries

  @since 1.6.0
  @private
 */

function changeColumn(qi, tableName, attributes, options) {
  const attributeName = Object.keys(attributes)[0];
  options = options || {};
  return qi.describeTable(tableName, options).then(fields => {
    fields[attributeName] = attributes[attributeName];
    const sql = qi.QueryGenerator.removeColumnQuery(tableName, fields);
    const subQueries = sql.split(';').filter(q => q !== '');
    return Promise.each(subQueries, subQuery => qi.sequelize.query(`${subQuery};`, Object.assign({
      raw: true
    }, options)));
  });
}

exports.changeColumn = changeColumn;
/**
  A wrapper that fixes SQLite's inability to rename columns from existing tables.
  It will create a backup of the table, drop the table afterwards and create a
  new table with the same name but with a renamed version of the respective column.

  @param  {QueryInterface} qi
  @param  {string} tableName The name of the table.
  @param  {string} attrNameBefore The name of the attribute before it was renamed.
  @param  {string} attrNameAfter The name of the attribute after it was renamed.
  @param  {Object} options
  @param  {boolean|Function} [options.logging] A function that logs the sql queries, or false for explicitly not logging these queries

  @since 1.6.0
  @private
 */

function renameColumn(qi, tableName, attrNameBefore, attrNameAfter, options) {
  options = options || {};
  return qi.describeTable(tableName, options).then(fields => {
    fields[attrNameAfter] = _.clone(fields[attrNameBefore]);
    delete fields[attrNameBefore];
    const sql = qi.QueryGenerator.renameColumnQuery(tableName, attrNameBefore, attrNameAfter, fields);
    const subQueries = sql.split(';').filter(q => q !== '');
    return Promise.each(subQueries, subQuery => qi.sequelize.query(`${subQuery};`, Object.assign({
      raw: true
    }, options)));
  });
}

exports.renameColumn = renameColumn;
/**
 * @param {QueryInterface} qi
 * @param {string} tableName
 * @param {string} constraintName
 * @param {Object} options
 *
 * @private
 */

function removeConstraint(qi, tableName, constraintName, options) {
  let createTableSql;
  return qi.showConstraint(tableName, constraintName).then(constraints => {
    // sqlite can't show only one constraint, so we find here the one to remove
    const constraint = constraints.find(constaint => constaint.constraintName === constraintName);

    if (constraint) {
      createTableSql = constraint.sql;
      constraint.constraintName = qi.QueryGenerator.quoteIdentifier(constraint.constraintName);
      let constraintSnippet = `, CONSTRAINT ${constraint.constraintName} ${constraint.constraintType} ${constraint.constraintCondition}`;

      if (constraint.constraintType === 'FOREIGN KEY') {
        const referenceTableName = qi.QueryGenerator.quoteTable(constraint.referenceTableName);
        constraint.referenceTableKeys = constraint.referenceTableKeys.map(columnName => qi.QueryGenerator.quoteIdentifier(columnName));
        const referenceTableKeys = constraint.referenceTableKeys.join(', ');
        constraintSnippet += ` REFERENCES ${referenceTableName} (${referenceTableKeys})`;
        constraintSnippet += ` ON UPDATE ${constraint.updateAction}`;
        constraintSnippet += ` ON DELETE ${constraint.deleteAction}`;
      }

      createTableSql = createTableSql.replace(constraintSnippet, '');
      createTableSql += ';';
      return qi.describeTable(tableName, options);
    }

    throw new sequelizeErrors.UnknownConstraintError({
      message: `Constraint ${constraintName} on table ${tableName} does not exist`,
      constraint: constraintName,
      table: tableName
    });
  }).then(fields => {
    const sql = qi.QueryGenerator._alterConstraintQuery(tableName, fields, createTableSql);

    const subQueries = sql.split(';').filter(q => q !== '');
    return Promise.each(subQueries, subQuery => qi.sequelize.query(`${subQuery};`, Object.assign({
      raw: true
    }, options)));
  });
}

exports.removeConstraint = removeConstraint;
/**
 * @param {QueryInterface} qi
 * @param {string} tableName
 * @param {Object} options
 *
 * @private
 */

function addConstraint(qi, tableName, options) {
  const constraintSnippet = qi.QueryGenerator.getConstraintSnippet(tableName, options);
  const describeCreateTableSql = qi.QueryGenerator.describeCreateTableQuery(tableName);
  let createTableSql;
  return qi.sequelize.query(describeCreateTableSql, Object.assign({}, options, {
    type: QueryTypes.SELECT,
    raw: true
  })).then(constraints => {
    const sql = constraints[0].sql;
    const index = sql.length - 1; //Replace ending ')' with constraint snippet - Simulates String.replaceAt
    //http://stackoverflow.com/questions/1431094

    createTableSql = `${sql.substr(0, index)}, ${constraintSnippet})${sql.substr(index + 1)};`;
    return qi.describeTable(tableName, options);
  }).then(fields => {
    const sql = qi.QueryGenerator._alterConstraintQuery(tableName, fields, createTableSql);

    const subQueries = sql.split(';').filter(q => q !== '');
    return Promise.each(subQueries, subQuery => qi.sequelize.query(`${subQuery};`, Object.assign({
      raw: true
    }, options)));
  });
}

exports.addConstraint = addConstraint;
/**
 * @param {QueryInterface} qi
 * @param {string} tableName
 * @param {Object} options  Query Options
 *
 * @private
 * @returns {Promise}
 */

function getForeignKeyReferencesForTable(qi, tableName, options) {
  const database = qi.sequelize.config.database;
  const query = qi.QueryGenerator.getForeignKeysQuery(tableName, database);
  return qi.sequelize.query(query, options).then(result => {
    return result.map(row => ({
      tableName,
      columnName: row.from,
      referencedTableName: row.table,
      referencedColumnName: row.to,
      tableCatalog: database,
      referencedTableCatalog: database
    }));
  });
}

exports.getForeignKeyReferencesForTable = getForeignKeyReferencesForTable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9kaWFsZWN0cy9zcWxpdGUvcXVlcnktaW50ZXJmYWNlLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiUHJvbWlzZSIsInNlcXVlbGl6ZUVycm9ycyIsIlF1ZXJ5VHlwZXMiLCJyZW1vdmVDb2x1bW4iLCJxaSIsInRhYmxlTmFtZSIsImF0dHJpYnV0ZU5hbWUiLCJvcHRpb25zIiwiZGVzY3JpYmVUYWJsZSIsInRoZW4iLCJmaWVsZHMiLCJzcWwiLCJRdWVyeUdlbmVyYXRvciIsInJlbW92ZUNvbHVtblF1ZXJ5Iiwic3ViUXVlcmllcyIsInNwbGl0IiwiZmlsdGVyIiwicSIsImVhY2giLCJzdWJRdWVyeSIsInNlcXVlbGl6ZSIsInF1ZXJ5IiwiT2JqZWN0IiwiYXNzaWduIiwicmF3IiwiZXhwb3J0cyIsImNoYW5nZUNvbHVtbiIsImF0dHJpYnV0ZXMiLCJrZXlzIiwicmVuYW1lQ29sdW1uIiwiYXR0ck5hbWVCZWZvcmUiLCJhdHRyTmFtZUFmdGVyIiwiY2xvbmUiLCJyZW5hbWVDb2x1bW5RdWVyeSIsInJlbW92ZUNvbnN0cmFpbnQiLCJjb25zdHJhaW50TmFtZSIsImNyZWF0ZVRhYmxlU3FsIiwic2hvd0NvbnN0cmFpbnQiLCJjb25zdHJhaW50cyIsImNvbnN0cmFpbnQiLCJmaW5kIiwiY29uc3RhaW50IiwicXVvdGVJZGVudGlmaWVyIiwiY29uc3RyYWludFNuaXBwZXQiLCJjb25zdHJhaW50VHlwZSIsImNvbnN0cmFpbnRDb25kaXRpb24iLCJyZWZlcmVuY2VUYWJsZU5hbWUiLCJxdW90ZVRhYmxlIiwicmVmZXJlbmNlVGFibGVLZXlzIiwibWFwIiwiY29sdW1uTmFtZSIsImpvaW4iLCJ1cGRhdGVBY3Rpb24iLCJkZWxldGVBY3Rpb24iLCJyZXBsYWNlIiwiVW5rbm93bkNvbnN0cmFpbnRFcnJvciIsIm1lc3NhZ2UiLCJ0YWJsZSIsIl9hbHRlckNvbnN0cmFpbnRRdWVyeSIsImFkZENvbnN0cmFpbnQiLCJnZXRDb25zdHJhaW50U25pcHBldCIsImRlc2NyaWJlQ3JlYXRlVGFibGVTcWwiLCJkZXNjcmliZUNyZWF0ZVRhYmxlUXVlcnkiLCJ0eXBlIiwiU0VMRUNUIiwiaW5kZXgiLCJsZW5ndGgiLCJzdWJzdHIiLCJnZXRGb3JlaWduS2V5UmVmZXJlbmNlc0ZvclRhYmxlIiwiZGF0YWJhc2UiLCJjb25maWciLCJnZXRGb3JlaWduS2V5c1F1ZXJ5IiwicmVzdWx0Iiwicm93IiwiZnJvbSIsInJlZmVyZW5jZWRUYWJsZU5hbWUiLCJyZWZlcmVuY2VkQ29sdW1uTmFtZSIsInRvIiwidGFibGVDYXRhbG9nIiwicmVmZXJlbmNlZFRhYmxlQ2F0YWxvZyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsTUFBTUEsQ0FBQyxHQUFHQyxPQUFPLENBQUMsUUFBRCxDQUFqQjs7QUFDQSxNQUFNQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxlQUFELENBQXZCOztBQUNBLE1BQU1FLGVBQWUsR0FBR0YsT0FBTyxDQUFDLGNBQUQsQ0FBL0I7O0FBQ0EsTUFBTUcsVUFBVSxHQUFHSCxPQUFPLENBQUMsbUJBQUQsQ0FBMUI7QUFFQTs7Ozs7Ozs7QUFRQTs7Ozs7Ozs7Ozs7Ozs7OztBQWNBLFNBQVNJLFlBQVQsQ0FBc0JDLEVBQXRCLEVBQTBCQyxTQUExQixFQUFxQ0MsYUFBckMsRUFBb0RDLE9BQXBELEVBQTZEO0FBQzNEQSxFQUFBQSxPQUFPLEdBQUdBLE9BQU8sSUFBSSxFQUFyQjtBQUVBLFNBQU9ILEVBQUUsQ0FBQ0ksYUFBSCxDQUFpQkgsU0FBakIsRUFBNEJFLE9BQTVCLEVBQXFDRSxJQUFyQyxDQUEwQ0MsTUFBTSxJQUFJO0FBQ3pELFdBQU9BLE1BQU0sQ0FBQ0osYUFBRCxDQUFiO0FBRUEsVUFBTUssR0FBRyxHQUFHUCxFQUFFLENBQUNRLGNBQUgsQ0FBa0JDLGlCQUFsQixDQUFvQ1IsU0FBcEMsRUFBK0NLLE1BQS9DLENBQVo7QUFDQSxVQUFNSSxVQUFVLEdBQUdILEdBQUcsQ0FBQ0ksS0FBSixDQUFVLEdBQVYsRUFBZUMsTUFBZixDQUFzQkMsQ0FB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S0FBbkIsRUFBMEJkLE9BQTFCLEVBQ0pFLElBREksQ0FDQytELE1BQU0sSUFBSTtBQUNkLFdBQU9BLE1BQU0sQ0FBQ3ZCLEdBQVAsQ0FBV3dCLEdBQUcsS0FBSztBQUN4QnBFLE1BQUFBLFNBRHdCO0FBRXhCNkMsTUFBQUEsVUFBVSxFQUFFdUIsR0FBRyxDQUFDQyxJQUZRO0FBR3hCQyxNQUFBQSxtQkFBbUIsRUFBRUYsR0FBRyxDQUFDaEIsS0FIRDtBQUl4Qm1CLE1BQUFBLG9CQUFvQixFQUFFSCxHQUFHLENBQUNJLEVBSkY7QUFLeEJDLE1BQUFBLFlBQVksRUFBRVQsUUFMVTtBQU14QlUsTUFBQUEsc0JBQXNCLEVBQUVWO0FBTkEsS0FBTCxDQUFkLENBQVA7QUFRRCxHQVZJLENBQVA7QUFXRDs7QUFFRDVDLE9BQU8sQ0FBQzJDLCtCQUFSLEdBQTBDQSwrQkFBMUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XHJcbmNvbnN0IFByb21pc2UgPSByZXF1aXJlKCcuLi8uLi9wcm9taXNlJyk7XHJcbmNvbnN0IHNlcXVlbGl6ZUVycm9ycyA9IHJlcXVpcmUoJy4uLy4uL2Vycm9ycycpO1xyXG5jb25zdCBRdWVyeVR5cGVzID0gcmVxdWlyZSgnLi4vLi4vcXVlcnktdHlwZXMnKTtcclxuXHJcbi8qKlxyXG4gUmV0dXJucyBhbiBvYmplY3QgdGhhdCB0cmVhdHMgU1FMaXRlJ3MgaW5hYmlsaXRpZXMgdG8gZG8gY2VydGFpbiBxdWVyaWVzLlxyXG5cclxuIEBjbGFzcyBRdWVyeUludGVyZmFjZVxyXG4gQHN0YXRpY1xyXG4gQHByaXZhdGVcclxuICovXHJcblxyXG4vKipcclxuICBBIHdyYXBwZXIgdGhhdCBmaXhlcyBTUUxpdGUncyBpbmFiaWxpdHkgdG8gcmVtb3ZlIGNvbHVtbnMgZnJvbSBleGlzdGluZyB0YWJsZXMuXHJcbiAgSXQgd2lsbCBjcmVhdGUgYSBiYWNrdXAgb2YgdGhlIHRhYmxlLCBkcm9wIHRoZSB0YWJsZSBhZnRlcndhcmRzIGFuZCBjcmVhdGUgYVxyXG4gIG5ldyB0YWJsZSB3aXRoIHRoZSBzYW1lIG5hbWUgYnV0IHdpdGhvdXQgdGhlIG9ic29sZXRlIGNvbHVtbi5cclxuXHJcbiAgQHBhcmFtICB7UXVlcnlJbnRlcmZhY2V9IHFpXHJcbiAgQHBhcmFtICB7c3RyaW5nfSB0YWJsZU5hbWUgICAgIFRoZSBuYW1lIG9mIHRoZSB0YWJsZS5cclxuICBAcGFyYW0gIHtzdHJpbmd9IGF0dHJpYnV0ZU5hbWUgVGhlIG5hbWUgb2YgdGhlIGF0dHJpYnV0ZSB0aGF0IHdlIHdhbnQgdG8gcmVtb3ZlLlxyXG4gIEBwYXJhbSAge09iamVjdH0gb3B0aW9uc1xyXG4gIEBwYXJhbSAge2Jvb2xlYW58RnVuY3Rpb259IFtvcHRpb25zLmxvZ2dpbmddIEEgZnVuY3Rpb24gdGhhdCBsb2dzIHRoZSBzcWwgcXVlcmllcywgb3IgZmFsc2UgZm9yIGV4cGxpY2l0bHkgbm90IGxvZ2dpbmcgdGhlc2UgcXVlcmllc1xyXG5cclxuICBAc2luY2UgMS42LjBcclxuICBAcHJpdmF0ZVxyXG4gKi9cclxuZnVuY3Rpb24gcmVtb3ZlQ29sdW1uKHFpLCB0YWJsZU5hbWUsIGF0dHJpYnV0ZU5hbWUsIG9wdGlvbnMpIHtcclxuICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcclxuXHJcbiAgcmV0dXJuIHFpLmRlc2NyaWJlVGFibGUodGFibGVOYW1lLCBvcHRpb25zKS50aGVuKGZpZWxkcyA9PiB7XHJcbiAgICBkZWxldGUgZmllbGRzW2F0dHJpYnV0ZU5hbWVdO1xyXG5cclxuICAgIGNvbnN0IHNxbCA9IHFpLlF1ZXJ5R2VuZXJhdG9yLnJlbW92ZUNvbHVtblF1ZXJ5KHRhYmxlTmFtZSwgZmllbGRzKTtcclxuICAgIGNvbnN0IHN1YlF1ZXJpZXMgPSBzcWwuc3BsaXQoJzsnKS5maWx0ZXIocSA9PiBxICE9PSAnJyk7XHJcblxyXG4gICAgcmV0dXJuIFByb21pc2UuZWFjaChzdWJRdWVyaWVzLCBzdWJRdWVyeSA9PiBxaS5zZXF1ZWxpemUucXVlcnkoYCR7c3ViUXVlcnl9O2AsIE9iamVjdC5hc3NpZ24oeyByYXc6IHRydWUgfSwgb3B0aW9ucykpKTtcclxuICB9KTtcclxufVxyXG5leHBvcnRzLnJlbW92ZUNvbHVtbiA9IHJlbW92ZUNvbHVtbjtcclxuXHJcbi8qKlxyXG4gIEEgd3JhcHBlciB0aGF0IGZpeGVzIFNRTGl0ZSdzIGluYWJpbGl0eSB0byBjaGFuZ2UgY29sdW1ucyBmcm9tIGV4aXN0aW5nIHRhYmxlcy5cclxuICBJdCB3aWxsIGNyZWF0ZSBhIGJhY2t1cCBvZiB0aGUgdGFibGUsIGRyb3AgdGhlIHRhYmxlIGFmdGVyd2FyZHMgYW5kIGNyZWF0ZSBhXHJcbiAgbmV3IHRhYmxlIHdpdGggdGhlIHNhbWUgbmFtZSBidXQgd2l0aCBhIG1vZGlmaWVkIHZlcnNpb24gb2YgdGhlIHJlc3BlY3RpdmUgY29sdW1uLlxyXG5cclxuICBAcGFyYW0gIHtRdWVyeUludGVyZmFjZX0gcWlcclxuICBAcGFyYW0gIHtzdHJpbmd9IHRhYmxlTmFtZSBUaGUgbmFtZSBvZiB0aGUgdGFibGUuXHJcbiAgQHBhcmFtICB7T2JqZWN0fSBhdHRyaWJ1dGVzIEFuIG9iamVjdCB3aXRoIHRoZSBhdHRyaWJ1dGUncyBuYW1lIGFzIGtleSBhbmQgaXRzIG9wdGlvbnMgYXMgdmFsdWUgb2JqZWN0LlxyXG4gIEBwYXJhbSAge09iamVjdH0gb3B0aW9uc1xyXG4gIEBwYXJhbSAge2Jvb2xlYW58RnVuY3Rpb259IFtvcHRpb25zLmxvZ2dpbmddIEEgZnVuY3Rpb24gdGhhdCBsb2dzIHRoZSBzcWwgcXVlcmllcywgb3IgZmFsc2UgZm9yIGV4cGxpY2l0bHkgbm90IGxvZ2dpbmcgdGhlc2UgcXVlcmllc1xyXG5cclxuICBAc2luY2UgMS42LjBcclxuICBAcHJpdmF0ZVxyXG4gKi9cclxuZnVuY3Rpb24gY2hhbmdlQ29sdW1uKHFpLCB0YWJsZU5hbWUsIGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHtcclxuICBjb25zdCBhdHRyaWJ1dGVOYW1lID0gT2JqZWN0LmtleXMoYXR0cmlidXRlcylbMF07XHJcbiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XHJcblxyXG4gIHJldHVybiBxaS5kZXNjcmliZVRhYmxlKHRhYmxlTmFtZSwgb3B0aW9ucykudGhlbihmaWVsZHMgPT4ge1xyXG4gICAgZmllbGRzW2F0dHJpYnV0ZU5hbWVdID0gYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXTtcclxuXHJcbiAgICBjb25zdCBzcWwgPSBxaS5RdWVyeUdlbmVyYXRvci5yZW1vdmVDb2x1bW5RdWVyeSh0YWJsZU5hbWUsIGZpZWxkcyk7XHJcbiAgICBjb25zdCBzdWJRdWVyaWVzID0gc3FsLnNwbGl0KCc7JykuZmlsdGVyKHEgPT4gcSAhPT0gJycpO1xyXG5cclxuICAgIHJldHVybiBQcm9taXNlLmVhY2goc3ViUXVlcmllcywgc3ViUXVlcnkgPT4gcWkuc2VxdWVsaXplLnF1ZXJ5KGAke3N1YlF1ZXJ5fTtgLCBPYmplY3QuYXNzaWduKHsgcmF3OiB0cnVlIH0sIG9wdGlvbnMpKSk7XHJcbiAgfSk7XHJcbn1cclxuZXhwb3J0cy5jaGFuZ2VDb2x1bW4gPSBjaGFuZ2VDb2x1bW47XHJcblxyXG4vKipcclxuICBBIHdyYXBwZXIgdGhhdCBmaXhlcyBTUUxpdGUncyBpbmFiaWxpdHkgdG8gcmVuYW1lIGNvbHVtbnMgZnJvbSBleGlzdGluZyB0YWJsZXMuXHJcbiAgSXQgd2lsbCBjcmVhdGUgYSBiYWNrdXAgb2YgdGhlIHRhYmxlLCBkcm9wIHRoZSB0YWJsZSBhZnRlcndhcmRzIGFuZCBjcmVhdGUgYVxyXG4gIG5ldyB0YWJsZSB3aXRoIHRoZSBzYW1lIG5hbWUgYnV0IHdpdGggYSByZW5hbWVkIHZlcnNpb24gb2YgdGhlIHJlc3BlY3RpdmUgY29sdW1uLlxyXG5cclxuICBAcGFyYW0gIHtRdWVyeUludGVyZmFjZX0gcWlcclxuICBAcGFyYW0gIHtzdHJpbmd9IHRhYmxlTmFtZSBUaGUgbmFtZSBvZiB0aGUgdGFibGUuXHJcbiAgQHBhcmFtICB7c3RyaW5nfSBhdHRyTmFtZUJlZm9yZSBUaGUgbmFtZSBvZiB0aGUgYXR0cmlidXRlIGJlZm9yZSBpdCB3YXMgcmVuYW1lZC5cclxuICBAcGFyYW0gIHtzdHJpbmd9IGF0dHJOYW1lQWZ0ZXIgVGhlIG5hbWUgb2YgdGhlIGF0dHJpYnV0ZSBhZnRlciBpdCB3YXMgcmVuYW1lZC5cclxuICBAcGFyYW0gIHtPYmplY3R9IG9wdGlvbnNcclxuICBAcGFyYW0gIHtib29sZWFufEZ1bmN0aW9ufSBbb3B0aW9ucy5sb2dnaW5nXSBBIGZ1bmN0aW9uIHRoYXQgbG9ncyB0aGUgc3FsIHF1ZXJpZXMsIG9yIGZhbHNlIGZvciBleHBsaWNpdGx5IG5vdCBsb2dnaW5nIHRoZXNlIHF1ZXJpZXNcclxuXHJcbiAgQHNpbmNlIDEuNi4wXHJcbiAgQHByaXZhdGVcclxuICovXHJcbmZ1bmN0aW9uIHJlbmFtZUNvbHVtbihxaSwgdGFibGVOYW1lLCBhdHRyTmFtZUJlZm9yZSwgYXR0ck5hbWVBZnRlciwgb3B0aW9ucykge1xyXG4gIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xyXG5cclxuICByZXR1cm4gcWkuZGVzY3JpYmVUYWJsZSh0YWJsZU5hbWUsIG9wdGlvbnMpLnRoZW4oZmllbGRzID0+IHtcclxuICAgIGZpZWxkc1thdHRyTmFtZUFmdGVyXSA9IF8uY2xvbmUoZmllbGRzW2F0dHJOYW1lQmVmb3JlXSk7XHJcbiAgICBkZWxldGUgZmllbGRzW2F0dHJOYW1lQmVmb3JlXTtcclxuXHJcbiAgICBjb25zdCBzcWwgPSBxaS5RdWVyeUdlbmVyYXRvci5yZW5hbWVDb2x1bW5RdWVyeSh0YWJsZU5hbWUsIGF0dHJOYW1lQmVmb3JlLCBhdHRyTmFtZUFmdGVyLCBmaWVsZHMpO1xyXG4gICAgY29uc3Qgc3ViUXVlcmllcyA9IHNxbC5zcGxpdCgnOycpLmZpbHRlcihxID0+IHEgIT09ICcnKTtcclxuXHJcbiAgICByZXR1cm4gUHJvbWlzZS5lYWNoKHN1YlF1ZXJpZXMsIHN1YlF1ZXJ5ID0+IHFpLnNlcXVlbGl6ZS5xdWVyeShgJHtzdWJRdWVyeX07YCwgT2JqZWN0LmFzc2lnbih7IHJhdzogdHJ1ZSB9LCBvcHRpb25zKSkpO1xyXG4gIH0pO1xyXG59XHJcbmV4cG9ydHMucmVuYW1lQ29sdW1uID0gcmVuYW1lQ29sdW1uO1xyXG5cclxuLyoqXHJcbiAqIEBwYXJhbSB7UXVlcnlJbnRlcmZhY2V9IHFpXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSB0YWJsZU5hbWVcclxuICogQHBhcmFtIHtzdHJpbmd9IGNvbnN0cmFpbnROYW1lXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zXHJcbiAqXHJcbiAqIEBwcml2YXRlXHJcbiAqL1xyXG5mdW5jdGlvbiByZW1vdmVDb25zdHJhaW50KHFpLCB0YWJsZU5hbWUsIGNvbnN0cmFpbnROYW1lLCBvcHRpb25zKSB7XHJcbiAgbGV0IGNyZWF0ZVRhYmxlU3FsO1xyXG5cclxuICByZXR1cm4gcWkuc2hvd0NvbnN0cmFpbnQodGFibGVOYW1lLCBjb25zdHJhaW50TmFtZSlcclxuICAgIC50aGVuKGNvbnN0cmFpbnRzID0+IHtcclxuICAgICAgLy8gc3FsaXRlIGNhbid0IHNob3cgb25seSBvbmUgY29uc3RyYWludCwgc28gd2UgZmluZCBoZXJlIHRoZSBvbmUgdG8gcmVtb3ZlXHJcbiAgICAgIGNvbnN0IGNvbnN0cmFpbnQgPSBjb25zdHJhaW50cy5maW5kKGNvbnN0YWludCA9PiBjb25zdGFpbnQuY29uc3RyYWludE5hbWUgPT09IGNvbnN0cmFpbnROYW1lKTtcclxuXHJcbiAgICAgIGlmIChjb25zdHJhaW50KSB7XHJcbiAgICAgICAgY3JlYXRlVGFibGVTcWwgPSBjb25zdHJhaW50LnNxbDtcclxuICAgICAgICBjb25zdHJhaW50LmNvbnN0cmFpbnROYW1lID0gcWkuUXVlcnlHZW5lcmF0b3IucXVvdGVJZGVudGlmaWVyKGNvbnN0cmFpbnQuY29uc3RyYWludE5hbWUpO1xyXG4gICAgICAgIGxldCBjb25zdHJhaW50U25pcHBldCA9IGAsIENPTlNUUkFJTlQgJHtjb25zdHJhaW50LmNvbnN0cmFpbnROYW1lfSAke2NvbnN0cmFpbnQuY29uc3RyYWludFR5cGV9ICR7Y29uc3RyYWludC5jb25zdHJhaW50Q29uZGl0aW9ufWA7XHJcblxyXG4gICAgICAgIGlmIChjb25zdHJhaW50LmNvbnN0cmFpbnRUeXBlID09PSAnRk9SRUlHTiBLRVknKSB7XHJcbiAgICAgICAgICBjb25zdCByZWZlcmVuY2VUYWJsZU5hbWUgPSBxaS5RdWVyeUdlbmVyYXRvci5xdW90ZVRhYmxlKGNvbnN0cmFpbnQucmVmZXJlbmNlVGFibGVOYW1lKTtcclxuICAgICAgICAgIGNvbnN0cmFpbnQucmVmZXJlbmNlVGFibGVLZXlzID0gY29uc3RyYWludC5yZWZlcmVuY2VUYWJsZUtleXMubWFwKGNvbHVtbk5hbWUgPT4gcWkuUXVlcnlHZW5lcmF0b3IucXVvdGVJZGVudGlmaWVyKGNvbHVtbk5hbWUpKTtcclxuICAgICAgICAgIGNvbnN0IHJlZmVyZW5jZVRhYmxlS2V5cyA9IGNvbnN0cmFpbnQucmVmZXJlbmNlVGFibGVLZXlzLmpvaW4oJywgJyk7XHJcbiAgICAgICAgICBjb25zdHJhaW50U25pcHBldCArPSBgIFJFRkVSRU5DRVMgJHtyZWZlcmVuY2VUYWJsZU5hbWV9ICgke3JlZmVyZW5jZVRhYmxlS2V5c30pYDtcclxuICAgICAgICAgIGNvbnN0cmFpbnRTbmlwcGV0ICs9IGAgT04gVVBEQVRFICR7Y29uc3RyYWludC51cGRhdGVBY3Rpb259YDtcclxuICAgICAgICAgIGNvbnN0cmFpbnRTbmlwcGV0ICs9IGAgT04gREVMRVRFICR7Y29uc3RyYWludC5kZWxldGVBY3Rpb259YDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNyZWF0ZVRhYmxlU3FsID0gY3JlYXRlVGFibGVTcWwucmVwbGFjZShjb25zdHJhaW50U25pcHBldCwgJycpO1xyXG4gICAgICAgIGNyZWF0ZVRhYmxlU3FsICs9ICc7JztcclxuXHJcbiAgICAgICAgcmV0dXJuIHFpLmRlc2NyaWJlVGFibGUodGFibGVOYW1lLCBvcHRpb25zKTtcclxuICAgICAgfVxyXG4gICAgICB0aHJvdyBuZXcgc2VxdWVsaXplRXJyb3JzLlVua25vd25Db25zdHJhaW50RXJyb3Ioe1xyXG4gICAgICAgIG1lc3NhZ2U6IGBDb25zdHJhaW50ICR7Y29uc3RyYWludE5hbWV9IG9uIHRhYmxlICR7dGFibGVOYW1lfSBkb2VzIG5vdCBleGlzdGAsXHJcbiAgICAgICAgY29uc3RyYWludDogY29uc3RyYWludE5hbWUsXHJcbiAgICAgICAgdGFibGU6IHRhYmxlTmFtZVxyXG4gICAgICB9KTtcclxuICAgIH0pXHJcbiAgICAudGhlbihmaWVsZHMgPT4ge1xyXG4gICAgICBjb25zdCBzcWwgPSBxaS5RdWVyeUdlbmVyYXRvci5fYWx0ZXJDb25zdHJhaW50UXVlcnkodGFibGVOYW1lLCBmaWVsZHMsIGNyZWF0ZVRhYmxlU3FsKTtcclxuICAgICAgY29uc3Qgc3ViUXVlcmllcyA9IHNxbC5zcGxpdCgnOycpLmZpbHRlcihxID0+IHEgIT09ICcnKTtcclxuXHJcbiAgICAgIHJldHVybiBQcm9taXNlLmVhY2goc3ViUXVlcmllcywgc3ViUXVlcnkgPT4gcWkuc2VxdWVsaXplLnF1ZXJ5KGAke3N1YlF1ZXJ5fTtgLCBPYmplY3QuYXNzaWduKHsgcmF3OiB0cnVlIH0sIG9wdGlvbnMpKSk7XHJcbiAgICB9KTtcclxufVxyXG5leHBvcnRzLnJlbW92ZUNvbnN0cmFpbnQgPSByZW1vdmVDb25zdHJhaW50O1xyXG5cclxuLyoqXHJcbiAqIEBwYXJhbSB7UXVlcnlJbnRlcmZhY2V9IHFpXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSB0YWJsZU5hbWVcclxuICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnNcclxuICpcclxuICogQHByaXZhdGVcclxuICovXHJcbmZ1bmN0aW9uIGFkZENvbnN0cmFpbnQocWksIHRhYmxlTmFtZSwgb3B0aW9ucykge1xyXG4gIGNvbnN0IGNvbnN0cmFpbnRTbmlwcGV0ID0gcWkuUXVlcnlHZW5lcmF0b3IuZ2V0Q29uc3RyYWludFNuaXBwZXQodGFibGVOYW1lLCBvcHRpb25zKTtcclxuICBjb25zdCBkZXNjcmliZUNyZWF0ZVRhYmxlU3FsID0gcWkuUXVlcnlHZW5lcmF0b3IuZGVzY3JpYmVDcmVhdGVUYWJsZVF1ZXJ5KHRhYmxlTmFtZSk7XHJcbiAgbGV0IGNyZWF0ZVRhYmxlU3FsO1xyXG5cclxuICByZXR1cm4gcWkuc2VxdWVsaXplLnF1ZXJ5KGRlc2NyaWJlQ3JlYXRlVGFibGVTcWwsIE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMsIHsgdHlwZTogUXVlcnlUeXBlcy5TRUxFQ1QsIHJhdzogdHJ1ZSB9KSlcclxuICAgIC50aGVuKGNvbnN0cmFpbnRzID0+IHtcclxuICAgICAgY29uc3Qgc3FsID0gY29uc3RyYWludHNbMF0uc3FsO1xyXG4gICAgICBjb25zdCBpbmRleCA9IHNxbC5sZW5ndGggLSAxO1xyXG4gICAgICAvL1JlcGxhY2UgZW5kaW5nICcpJyB3aXRoIGNvbnN0cmFpbnQgc25pcHBldCAtIFNpbXVsYXRlcyBTdHJpbmcucmVwbGFjZUF0XHJcbiAgICAgIC8vaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8xNDMxMDk0XHJcbiAgICAgIGNyZWF0ZVRhYmxlU3FsID0gYCR7c3FsLnN1YnN0cigwLCBpbmRleCl9LCAke2NvbnN0cmFpbnRTbmlwcGV0fSkke3NxbC5zdWJzdHIoaW5kZXggKyAxKX07YDtcclxuXHJcbiAgICAgIHJldHVybiBxaS5kZXNjcmliZVRhYmxlKHRhYmxlTmFtZSwgb3B0aW9ucyk7XHJcbiAgICB9KVxyXG4gICAgLnRoZW4oZmllbGRzID0+IHtcclxuICAgICAgY29uc3Qgc3FsID0gcWkuUXVlcnlHZW5lcmF0b3IuX2FsdGVyQ29uc3RyYWludFF1ZXJ5KHRhYmxlTmFtZSwgZmllbGRzLCBjcmVhdGVUYWJsZVNxbCk7XHJcbiAgICAgIGNvbnN0IHN1YlF1ZXJpZXMgPSBzcWwuc3BsaXQoJzsnKS5maWx0ZXIocSA9PiBxICE9PSAnJyk7XHJcblxyXG4gICAgICByZXR1cm4gUHJvbWlzZS5lYWNoKHN1YlF1ZXJpZXMsIHN1YlF1ZXJ5ID0+IHFpLnNlcXVlbGl6ZS5xdWVyeShgJHtzdWJRdWVyeX07YCwgT2JqZWN0LmFzc2lnbih7IHJhdzogdHJ1ZSB9LCBvcHRpb25zKSkpO1xyXG4gICAgfSk7XHJcbn1cclxuZXhwb3J0cy5hZGRDb25zdHJhaW50ID0gYWRkQ29uc3RyYWludDtcclxuXHJcbi8qKlxyXG4gKiBAcGFyYW0ge1F1ZXJ5SW50ZXJmYWNlfSBxaVxyXG4gKiBAcGFyYW0ge3N0cmluZ30gdGFibGVOYW1lXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zICBRdWVyeSBPcHRpb25zXHJcbiAqXHJcbiAqIEBwcml2YXRlXHJcbiAqIEByZXR1cm5zIHtQcm9taXNlfVxyXG4gKi9cclxuZnVuY3Rpb24gZ2V0Rm9yZWlnbktleVJlZmVyZW5jZXNGb3JUYWJsZShxaSwgdGFibGVOYW1lLCBvcHRpb25zKSB7XHJcbiAgY29uc3QgZGF0YWJhc2UgPSBxaS5zZXF1ZWxpemUuY29uZmlnLmRhdGFiYXNlO1xyXG4gIGNvbnN0IHF1ZXJ5ID0gcWkuUXVlcnlHZW5lcmF0b3IuZ2V0Rm9yZWlnbktleXNRdWVyeSh0YWJsZU5hbWUsIGRhdGFiYXNlKTtcclxuICByZXR1cm4gcWkuc2VxdWVsaXplLnF1ZXJ5KHF1ZXJ5LCBvcHRpb25zKVxyXG4gICAgLnRoZW4ocmVzdWx0ID0+IHtcclxuICAgICAgcmV0dXJuIHJlc3VsdC5tYXAocm93ID0+ICh7XHJcbiAgICAgICAgdGFibGVOYW1lLFxyXG4gICAgICAgIGNvbHVtbk5hbWU6IHJvdy5mcm9tLFxyXG4gICAgICAgIHJlZmVyZW5jZWRUYWJsZU5hbWU6IHJvdy50YWJsZSxcclxuICAgICAgICByZWZlcmVuY2VkQ29sdW1uTmFtZTogcm93LnRvLFxyXG4gICAgICAgIHRhYmxlQ2F0YWxvZzogZGF0YWJhc2UsXHJcbiAgICAgICAgcmVmZXJlbmNlZFRhYmxlQ2F0YWxvZzogZGF0YWJhc2VcclxuICAgICAgfSkpO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbmV4cG9ydHMuZ2V0Rm9yZWlnbktleVJlZmVyZW5jZXNGb3JUYWJsZSA9IGdldEZvcmVpZ25LZXlSZWZlcmVuY2VzRm9yVGFibGU7XHJcbiJdfQ==